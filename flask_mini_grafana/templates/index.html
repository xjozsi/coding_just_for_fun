<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mini Grafana üß†</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #f8fafc;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        h1 { margin-top: 20px; }
        .grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            padding: 20px;
        }
        .card {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            box-shadow: 0 0 10px rgba(255,255,255,0.05);
        }
        table {
            width: 100%;
            color: #f8fafc;
            border-collapse: collapse;
        }
        th, td {
            border-bottom: 1px solid #334155;
            padding: 8px;
        }
    </style>
</head>
<body>
    <h1>üê≥ Mini Grafana - Local System Dashboard</h1>
    <div id="info"></div>

    <div class="grid">
        <div class="card"><canvas id="cpuChart"></canvas></div>
        <div class="card"><canvas id="memChart"></canvas></div>
        <div class="card"><canvas id="netChart"></canvas></div>
    </div>

    <div class="card" style="margin: auto;">
        <h3>Top 5 Processes</h3>
        <table id="procTable">
            <thead><tr><th>PID</th><th>Name</th><th>CPU%</th><th>Mem%</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="card" style="margin: 30px auto;">
        <h3>Disk Usage</h3>
        <table id="diskTable">
            <thead><tr><th>Mount</th><th>Used (GB)</th><th>Total (GB)</th><th>%</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const cpuChart = new Chart(document.getElementById('cpuChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'CPU %', data: [], borderColor: '#10b981' }] },
            options: { scales: { y: { min: 0, max: 100 } } }
        });

        const memChart = new Chart(document.getElementById('memChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Memory %', data: [], borderColor: '#facc15' }] },
            options: { scales: { y: { min: 0, max: 100 } } }
        });

        const netChart = new Chart(document.getElementById('netChart'), {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Bytes Sent', data: [], borderColor: '#3b82f6' },
                { label: 'Bytes Received', data: [], borderColor: '#ef4444' }
            ]},
        });

        async function fetchData() {
            const res = await fetch('/api/system');
            const data = await res.json();

            document.getElementById('info').innerHTML = `
                <p><b>${data.hostname}</b> | ${data.os} ${data.kernel} (${data.arch}) | Uptime: ${data.uptime}</p>
            `;

            const time = new Date().toLocaleTimeString();
            cpuChart.data.labels.push(time);
            memChart.data.labels.push(time);
            netChart.data.labels.push(time);
            cpuChart.data.datasets[0].data.push(data.cpu_percent);
            memChart.data.datasets[0].data.push(data.memory.percent);
            netChart.data.datasets[0].data.push(data.net.bytes_sent);
            netChart.data.datasets[1].data.push(data.net.bytes_recv);

            [cpuChart, memChart, netChart].forEach(c => {
                if (c.data.labels.length > 20) {
                    c.data.labels.shift();
                    c.data.datasets.forEach(ds => ds.data.shift());
                }
                c.update();
            });

            // Process table
            const procRows = data.processes.map(p => `
                <tr><td>${p.pid}</td><td>${p.name}</td><td>${p.cpu.toFixed(1)}</td><td>${p.mem.toFixed(1)}</td></tr>
            `).join("");
            document.querySelector("#procTable tbody").innerHTML = procRows;

            // Disk table
            const diskRows = data.disk.map(d => `
                <tr><td>${d.mountpoint}</td><td>${d.used}</td><td>${d.total}</td><td>${d.percent}%</td></tr>
            `).join("");
            document.querySelector("#diskTable tbody").innerHTML = diskRows;
        }

        setInterval(fetchData, 3000);
        fetchData();
    </script>
</body>
</html>
